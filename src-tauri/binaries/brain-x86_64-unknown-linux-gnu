#!/bin/bash
# Brain Sidecar - Fina Ergen
# FORZAR EJECUCIÃ“N DEL MAIN.PY DE ERGEN

ERGEN_MAIN="/home/claudio/Descargas/Fina-Ergen/main.py"

if [ ! -f "$ERGEN_MAIN" ]; then
  echo "Error: No se encontrÃ³ main.py de Ergen en $ERGEN_MAIN" >&2
  exit 1
fi

# Ejecutar desde el directorio de Ergen
cd "$(dirname "$ERGEN_MAIN")"

# Asegurar que procesos antiguos mueran (importante para AppImage)
pkill -f "fina_api.py"
pkill -f "$ERGEN_MAIN"
pkill -f "monitor_ergen.py"
pkill -f "mem_watchdog.py"

echo "ðŸ”Œ [Brain Wrapper] Iniciando fina_api.py..." >&2
/home/claudio/.venv/bin/python3 -u fina_api.py &
API_PID=$!

echo "ðŸ”Œ [Brain Wrapper] Iniciando monitor_ergen.py..." >&2
if [ -f "plugins/doorbell/monitor_ergen.py" ]; then
    /home/claudio/.venv/bin/python3 -u plugins/doorbell/monitor_ergen.py &
fi

if [ -f "mem_watchdog.py" ]; then
    /home/claudio/.venv/bin/python3 -u mem_watchdog.py &
fi

# Cleanup global at exit
cleanup() {
    echo "ðŸ›‘ [Brain Wrapper] Deteniendo procesos..." >&2
    pkill -P $$
}
trap cleanup EXIT INT TERM

echo "ðŸš€ [Brain Wrapper] Iniciando main.py con -u (Unbuffered)..." >&2
exec /home/claudio/.venv/bin/python3 -u "$ERGEN_MAIN"
