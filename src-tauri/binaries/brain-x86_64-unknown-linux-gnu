# Brain Sidecar - Fina Ergen
# GESTIÃ“N AUTOMÃTICA DE ENTORNO VIRTUAL Y DEPENDENCIAS

# Directorio donde se encuentra este script
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
ERGEN_ROOT="$(realpath "$SCRIPT_DIR/../../../")"
ERGEN_MAIN="$ERGEN_ROOT/main.py"

# En caso de no encontrarlo (ej: AppImage), fallback a carpeta actual
if [ ! -f "$ERGEN_MAIN" ]; then
    ERGEN_ROOT="$(pwd)"
    ERGEN_MAIN="$ERGEN_ROOT/main.py"
fi

# UbicaciÃ³n del VENV (Priorizamos .venv local, sino uno en el HOME del usuario para evitar problemas de permisos)
USER_VENV="$HOME/.local/share/Fina/venv"
LOCAL_VENV="$ERGEN_ROOT/.venv"

if [ -f "$LOCAL_VENV/bin/python3" ]; then
    PYTHON_BIN="$LOCAL_VENV/bin/python3"
else
    PYTHON_BIN="$USER_VENV/bin/python3"
fi

# --- INICIALIZACIÃ“N AUTOMÃTICA DEL ENTORNO ---
if [ ! -f "$PYTHON_BIN" ]; then
    echo "ðŸ› ï¸ Preparando entorno virtual por primera vez..." >&2
    mkdir -p "$(dirname "$USER_VENV")"
    python3 -m venv "$USER_VENV"
    PYTHON_BIN="$USER_VENV/bin/python3"
    
    # InstalaciÃ³n inicial de requerimientos si existen
    if [ -f "$ERGEN_ROOT/requirements.txt" ]; then
        echo "ðŸ“¦ Instalando dependencias de Fina (esto puede tardar unos minutos)..." >&2
        "$PYTHON_BIN" -m pip install --upgrade pip
        "$PYTHON_BIN" -m pip install -r "$ERGEN_ROOT/requirements.txt"
    fi
fi

# Verificar si se necesitan nuevas dependencias (comparando fecha de requirements.txt)
# Solo si el directorio es escribible
if [ -w "$ERGEN_ROOT" ] && [ -f "$ERGEN_ROOT/requirements.txt" ]; then
    # Un check simple para no re-instalar siempre: si requirements es mas nuevo que el venv
    if [ "$ERGEN_ROOT/requirements.txt" -nt "$PYTHON_BIN" ]; then
        echo "ðŸ”„ Actualizando dependencias detectadas..." >&2
        "$PYTHON_BIN" -m pip install -r "$ERGEN_ROOT/requirements.txt"
        touch "$PYTHON_BIN" # Actualizar fecha del binario como marcador
    fi
fi

# Ejecutar desde el directorio de Ergen
cd "$ERGEN_ROOT"

# Asegurar que procesos antiguos mueran
pkill -f "fina_api.py"
pkill -f "$ERGEN_MAIN"
pkill -f "monitor_ergen.py"

echo "ðŸ”Œ [Brain Wrapper] Iniciando servicios core..." >&2
"$PYTHON_BIN" -u fina_api.py &

if [ -f "plugins/doorbell/monitor_ergen.py" ]; then
    "$PYTHON_BIN" -u plugins/doorbell/monitor_ergen.py &
fi

# Cleanup global at exit
cleanup() {
    echo "ðŸ›‘ [Brain Wrapper] Deteniendo procesos..." >&2
    pkill -P $$
}
trap cleanup EXIT INT TERM

echo "ðŸš€ [Brain Wrapper] Iniciando CEREBRO..." >&2
exec "$PYTHON_BIN" -u "$ERGEN_MAIN"
