name: Release
on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  release:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        platform: [ubuntu-24.04]

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libjavascriptcoregtk-4.1-dev libsoup-3.0-dev rpm

      - name: Install frontend dependencies
        run: npm install

      - name: Download Piper Binary (Sidecar)
        run: |
          mkdir -p src-tauri/binaries
          if [ ! -f src-tauri/binaries/piper ]; then
            wget -O piper.tar.gz https://github.com/rhasspy/piper/releases/download/v1.2.0/piper_amd64.tar.gz
            tar -xzf piper.tar.gz
            cp piper/piper src-tauri/binaries/
            chmod +x src-tauri/binaries/piper
            rm -rf piper piper.tar.gz
          fi

      - uses: tauri-apps/tauri-action@v0.5.15
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: v__VERSION__
          releaseName: "Fina Ergen v__VERSION__"
          args: --bundles deb,rpm
          releaseBody: |
            ## üöÄ Fina Ergen v__VERSION__ - Edici√≥n "Cero Terminal" y Gu√≠a Proactiva

            Esta actualizaci√≥n transforma a Fina en un asistente modular completamente resiliente y amigable para el usuario novato.

            ### üõ†Ô∏è Novedades Cr√≠ticas:
            * **‚ö° Auto-Bootstrap (Zero Terminal)**: Fina ahora detecta autom√°ticamente si faltan librer√≠as cr√≠ticas de IA (Torch, Vosk, Sounddevice, etc.) y las instala sola en un entorno privado.
            * **üìñ Gu√≠a Proactiva para Novatos**: Apertura autom√°tica del manual de configuraci√≥n al detectar falta de modelos de voz/o√≠do.
            * **üõ°Ô∏è Blindaje de Configuraci√≥n**: Fina ya no cierra por errores en `config.py`; ahora arranca siempre y avisa qu√© falta.
            * **üìê Manual Centrado y Refinado**: El manual PDF y HTML ahora est√°n integrados en el paquete y dise√±ados para impresi√≥n y web.
            * **üßπ Limpieza de Logs**: Prevenci√≥n de saturaci√≥n de disco por logs repetitivos.

            ### üì¶ Instalaci√≥n:
            Descarga el archivo `.deb` o `.AppImage` e inst√°lalo normalmente. Fina te guiar√° en el primer arranque.
          releaseDraft: false
          prerelease: false

      - name: Build Manual AppImages (Standard & Slim XZ)
        run: |
          sudo apt-get install -y libfuse2
          wget -q "https://github.com/AppImage/appimagekit/releases/download/continuous/appimagetool-x86_64.AppImage"
          chmod +x appimagetool-x86_64.AppImage

          # Generar AppDir (Tauri suele fallar al final pero deja el AppDir listo)
          APPIMAGE_EXTRACT_AND_RUN=1 npm run tauri build -- --bundles appimage || true

          APP_DIR=$(ls -d src-tauri/target/release/bundle/appimage/*.AppDir | head -n 1)
          VERSION=$(node -p "require('./package.json').version")

          # Buscar el nombre del icono dentro del archivo desktop
          DESKTOP_PATH=$(find "$APP_DIR/usr/share/applications" -name "*.desktop" | head -n 1)
          ICON_NAME=$(grep "^Icon=" "$DESKTOP_PATH" | cut -d'=' -f2)

          # Inyectar iconos necesarios en la ra√≠z
          cp src-tauri/icons/128x128.png "$APP_DIR/$ICON_NAME.png"
          cp src-tauri/icons/128x128.png "$APP_DIR/.DirIcon"

          cd "$APP_DIR"
          rm -f *.desktop
          ln -s "usr/share/applications/$(basename "$DESKTOP_PATH")" "$(basename "$DESKTOP_PATH")"
          cd ../../../../../../

          echo "üì¶ Generando AppImage Est√°ndar..."
          APPIMAGE_EXTRACT_AND_RUN=1 ./appimagetool-x86_64.AppImage --no-appstream "$APP_DIR" fina-ergen-std.AppImage

          echo "üì¶ Generando AppImage XZ..."
          APPIMAGE_EXTRACT_AND_RUN=1 ./appimagetool-x86_64.AppImage --no-appstream --comp xz "$APP_DIR" fina-ergen-xz.AppImage

          GH_TOKEN=${{ secrets.GITHUB_TOKEN }} gh release upload "v${VERSION}" fina-ergen-std.AppImage#"fina-ergen_${VERSION}_x86_64.AppImage" --clobber
          GH_TOKEN=${{ secrets.GITHUB_TOKEN }} gh release upload "v${VERSION}" fina-ergen-xz.AppImage#"fina-ergen_${VERSION}_amd64.AppImage" --clobber
