name: Release
on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  release:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        platform: [ubuntu-24.04]

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libjavascriptcoregtk-4.1-dev libsoup-3.0-dev rpm libfuse2

      - name: Install frontend dependencies
        run: npm install

      - name: Download Piper Binary (Sidecar)
        run: |
          mkdir -p src-tauri/binaries
          if [ ! -f src-tauri/binaries/piper ]; then
            wget -O piper.tar.gz https://github.com/rhasspy/piper/releases/download/v1.2.0/piper_amd64.tar.gz
            tar -xzf piper.tar.gz
            cp piper/piper src-tauri/binaries/
            chmod +x src-tauri/binaries/piper
            rm -rf piper piper.tar.gz
          fi

      - uses: tauri-apps/tauri-action@v0.5.15
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          APPIMAGE_EXTRACT_AND_RUN: 1
        with:
          tagName: v__VERSION__
          releaseName: "Fina Ergen v__VERSION__"
          releaseBody: |
            ## üöÄ Fina Ergen v__VERSION__ - Edici√≥n "Cero Terminal" y Gu√≠a Proactiva

            Esta actualizaci√≥n transforma a Fina en un asistente modular completamente resiliente y amigable para el usuario novato.

            ### üõ†Ô∏è Novedades Cr√≠ticas:
            * **‚ö° Auto-Bootstrap (Zero Terminal)**: Fina ahora detecta autom√°ticamente si faltan librer√≠as cr√≠ticas de IA (Torch, Vosk, Sounddevice, etc.) y las instala sola en un entorno privado.
            * **üìñ Gu√≠a Proactiva para Novatos**: Apertura autom√°tica del manual de configuraci√≥n al detectar falta de modelos de voz/o√≠do.
            * **üõ°Ô∏è Blindaje de Configuraci√≥n**: Fina ya no cierra por errores en `config.py`; ahora arranca siempre y avisa qu√© falta.
            * **üìê Manual Centrado y Refinado**: El manual PDF y HTML ahora est√°n integrados en el paquete y dise√±ados para impresi√≥n y web.
            * **üßπ Limpieza de Logs**: Prevenci√≥n de saturaci√≥n de disco por logs repetitivos.

            ### üì¶ Instalaci√≥n:
            Descarga el archivo `.deb` o `.AppImage` e inst√°lalo normalmente. Fina te guiar√° en el primer arranque.
          releaseDraft: false
          prerelease: false

      - name: Build Slim XZ AppImage
        run: |
          wget -q "https://github.com/AppImage/appimagekit/releases/download/continuous/appimagetool-x86_64.AppImage"
          chmod +x appimagetool-x86_64.AppImage

          APP_DIR=src-tauri/target/release/bundle/appimage/fina-ergen.AppDir
          VERSION=$(node -p "require('./package.json').version")

          cd "$APP_DIR"
          rm -f fina-ergen.desktop .DirIcon
          ln -s usr/share/applications/fina-ergen.desktop fina-ergen.desktop
          ln -s fina-ergen.png .DirIcon
          cd ../../../../../../

          echo "üì¶ Generando AppImage XZ (Slim)..."
          APPIMAGE_EXTRACT_AND_RUN=1 ARCH=x86_64 ./appimagetool-x86_64.AppImage --comp xz "$APP_DIR" fina-ergen-xz.AppImage

          GH_TOKEN=${{ secrets.GITHUB_TOKEN }} gh release upload "v${VERSION}" fina-ergen-xz.AppImage#"fina-ergen_${VERSION}_amd64.AppImage" --clobber
