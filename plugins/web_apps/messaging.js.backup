import { invoke } from "@tauri-apps/api/core";
import { WebviewWindow } from "@tauri-apps/api/webviewWindow";

const isTauri = !!(window.__TAURI_INTERNALS__ || window.__TAURI_IPC__);

export const SUPPORTED_MESSAGING_APPS = {
    'sms': {
        id: 'sms',
        name: 'SMS',
        package: 'com.android.mms',
        icon: 'fa-solid fa-comment-sms',
        color: 'text-blue-500',
        isDefault: true
    },
    'whatsapp': {
        id: 'whatsapp',
        name: 'WhatsApp',
        package: 'com.whatsapp',
        icon: 'fa-brands fa-whatsapp',
        color: 'text-green-500',
        uri: 'https://api.whatsapp.com/send?phone={phone}&text={text}'
    },
    'telegram': {
        id: 'telegram',
        name: 'Telegram',
        package: 'org.telegram.messenger',
        icon: 'fa-brands fa-telegram',
        color: 'text-cyan-400',
        uri: 'tg://msg?text={text}&to={phone}'
    },
    'messenger': {
        id: 'messenger',
        name: 'Messenger',
        package: 'com.facebook.orca',
        icon: 'fa-brands fa-facebook-messenger',
        color: 'text-blue-600',
        uri: 'fb-messenger://share?link={text}'
    },
    'instagram': {
        id: 'instagram',
        name: 'Instagram',
        package: 'com.instagram.android',
        icon: 'fa-brands fa-instagram',
        color: 'text-pink-500',
        uri: 'instagram://'
    },
    'discord': {
        id: 'discord',
        name: 'Discord',
        package: 'com.discord',
        icon: 'fa-brands fa-discord',
        color: 'text-indigo-500',
        uri: 'discord://'
    },
    'signal': {
        id: 'signal',
        name: 'Signal',
        package: 'org.thoughtcrime.securesms',
        icon: 'fa-solid fa-shield-halved',
        color: 'text-indigo-400',
        uri: 'smsto:{phone}:{text}'
    },
    'wechat': {
        id: 'wechat',
        name: 'WeChat',
        package: 'com.tencent.mm',
        icon: 'fa-brands fa-weixin',
        color: 'text-green-600',
        uri: 'weixin://'
    },
    'qq': {
        id: 'qq',
        name: 'QQ',
        package: 'com.tencent.mobileqq',
        icon: 'fa-brands fa-qq',
        color: 'text-blue-500',
        uri: 'mqqwpa://im/chat?chat_type=wpa&uin={phone}&version=1&src_type=web'
    },
    'viber': {
        id: 'viber',
        name: 'Viber',
        package: 'com.viber.voip',
        icon: 'fa-brands fa-viber',
        color: 'text-purple-600',
        uri: 'viber://chat?number={phone}'
    }
};

export const MESSAGING_URLS = {
    'whatsapp': 'https://web.whatsapp.com',
    'telegram': 'https://web.telegram.org/a/',
    'messenger': 'https://www.messenger.com',
    'instagram': 'https://www.instagram.com/direct/inbox/',
    'discord': 'https://discord.com/app',
    'signal': 'https://signal.org',
    'sms': '/messaging.html'
};

// --- WEBVIEW AUTOMATION SCRIPTS ---
export const INJECT_SCRIPTS = {
    whatsapp: `
if (!window.FinaWhatsapp) {
    // Mini monitor visual (barra superior delgada)
    let monitor = document.getElementById('fina-wa-monitor');
    if (!monitor) {
        monitor = document.createElement('div');
        monitor.id = 'fina-wa-monitor';
        monitor.style = "position:fixed; top:0; left:0; right:0; height:24px; background:rgba(0,128,128,0.85); color:white; font-family:sans-serif; font-size:12px; display:flex; align-items:center; padding:0 15px; z-index:99999; pointer-events:none; border-bottom:1px solid #00f0f0; transition: all 0.5s;";
        monitor.innerHTML = "<b>ðŸ¤– FINA ROBOT:</b> <span id='fina-wa-status' style='margin-left:10px;'>Esperando Ã³rdenes...</span>";
        document.body.appendChild(monitor);
    }

    const setStatus = (msg) => {
        const s = document.getElementById('fina-wa-status');
        if (s) s.innerText = msg;
        console.log("[Fina WA]", msg);
        if (window.__TAURI_INTERNALS__) {
            window.__TAURI_INTERNALS__.invoke("plugin:event|emit", { 
                event: "wa-perf-log", 
                payload: "ROBOT: " + msg 
            }).catch(() => {});
        }
    };

    window.FinaWhatsapp = {
        selectors: { 
            searchBox: "div[contenteditable='true'][data-tab='3'], div.lexical-rich-text-input div[contenteditable='true'], #side div[contenteditable='true']", 
            messageBox: "div[title='Escribe un mensaje'], div.lexical-rich-text-input div[role='textbox'], #main footer div[contenteditable='true']", 
            sendButton: "span[data-icon='send'], button[aria-label='Enviar'], button[aria-label='Send']",
            resultsList: "div[data-testid='cell-frame-container'], div[role='listitem']"
        },
        sendMessage: async function (contact, msg) {
            try {
                setStatus("ðŸš€ Iniciando envÃ­o a " + contact);
                
                const waitFor = (sel, timeout = 12000) => {
                    return new Promise(res => {
                        const start = Date.now();
                        const check = () => {
                            const el = document.querySelector(sel);
                            if (el) res(el);
                            else if (Date.now() - start > timeout) res(null);
                            else setTimeout(check, 500);
                        };
                        check();
                    });
                };

                // 1. BUSCAR CONTACTO
                setStatus("ðŸ” Localizando buscador...");
                let sBox = await waitFor(this.selectors.searchBox);
                if (!sBox) {
                    setStatus("âš ï¸ Buscador no detectado, usando fallback...");
                    sBox = document.querySelector("div[contenteditable='true']");
                }

                if (!sBox) {
                    setStatus("âŒ ERROR: No encontrÃ© donde escribir el nombre.");
                    return {error: "Search box missing"};
                }

                sBox.focus();
                document.execCommand('selectAll', false, null);
                document.execCommand('delete', false, null);
                
                setStatus("âœï¸ Escribiendo: " + contact);
                for(let c of contact) {
                    document.execCommand('insertText', false, c);
                    await new Promise(r => setTimeout(r, 45));
                }
                
                setStatus("â³ Esperando lista de contactos...");
                await new Promise(r => setTimeout(r, 2200));
                
                let resList = document.querySelector(this.selectors.resultsList);
                if (!resList) {
                    setStatus("âŒ¨ï¸ Forzando Enter para buscar...");
                    sBox.dispatchEvent(new KeyboardEvent('keydown', {bubbles:true, keyCode:13, key:'Enter'}));
                    await new Promise(r => setTimeout(r, 1800));
                    resList = document.querySelector(this.selectors.resultsList);
                }

                if (resList) {
                    resList.click();
                    setStatus("âœ… Chat abierto.");
                } else {
                    setStatus("âš ï¸ No vi el contacto en lista, reintentando con Enter...");
                    sBox.dispatchEvent(new KeyboardEvent('keydown', {bubbles:true, keyCode:13, key:'Enter'}));
                }

                // 2. ENVIAR MENSAJE
                setStatus("ðŸ“ Localizando caja de mensaje...");
                let mBox = await waitFor(this.selectors.messageBox, 6000);
                if (!mBox) {
                    setStatus("ðŸ”„ Reintentando clic en chat...");
                    const retry = document.querySelector(this.selectors.resultsList);
                    if (retry) retry.click();
                    mBox = await waitFor(this.selectors.messageBox, 4000);
                }

                if (!mBox) {
                    setStatus("âŒ ERROR: No se pudo abrir el chat de destino.");
                    return {error: "Chat not opened"};
                }

                mBox.focus();
                document.execCommand('insertText', false, msg);
                setStatus("ðŸ’¾ Mensaje inyectado.");
                await new Promise(r => setTimeout(r, 1200));

                const sendBtn = document.querySelector(this.selectors.sendButton);
                if (sendBtn) {
                    sendBtn.click();
                    setStatus("âœ… Mensaje enviado (Clic en botÃ³n).");
                } else {
                    setStatus("âŒ¨ï¸ Enviando vÃ­a Enter...");
                    mBox.dispatchEvent(new KeyboardEvent('keydown', {bubbles:true, keyCode:13, key:'Enter'}));
                }

                setStatus("ðŸŽ¯ FINALIZADO CON Ã‰XITO.");
                setTimeout(() => setStatus("Sistema listo."), 5000);
                return {success: true};
            } catch (e) {
                setStatus("ðŸ’¥ CRASH: " + e.message);
                return {error: e.message};
            }
        }
    };
}`,
    telegram: `
if (!window.FinaTelegram) {
    console.log("Fina: Telegram Injection Loaded");
    window.FinaTelegram = {
        sendMessage: async function (contact, msg) {
            const search = document.querySelector("input[type='text']"); 
            if(!search) return {error:"Search 404"};
            search.focus(); document.execCommand('insertText', false, contact);
            await new Promise(r=>setTimeout(r,2000));
            search.dispatchEvent(new KeyboardEvent('keydown',{bubbles:true,cancelable:true,keyCode:13,key:'Enter'}));
            await new Promise(r=>setTimeout(r,1500));
            const msgBox = document.querySelector("#editable-message-text") || document.querySelector("div[contenteditable='true'][inputmode='text']");
            if(!msgBox) return {error:"MsgBox 404"};
            msgBox.focus(); document.execCommand('insertText', false, msg);
            await new Promise(r=>setTimeout(r,800));
            const btn = document.querySelector("button[title='Send Message']") || document.querySelector(".send"); 
            if(btn) btn.click(); else msgBox.dispatchEvent(new KeyboardEvent('keydown',{bubbles:true,cancelable:true,keyCode:13,key:'Enter'}));
            return {success:true};
        }
    };
}`,
    messenger: `
if (!window.FinaMessenger) {
    console.log("Fina: Messenger Injection Loaded");
    window.FinaMessenger = {
        sendMessage: async function (contact, msg) {
            const search = document.querySelector("input[aria-label='Search Messenger']");
            if(!search) return {error:"Search 404"};
            search.focus(); document.execCommand('insertText', false, contact);
            await new Promise(r=>setTimeout(r,2500));
            const firstRes = document.querySelector("ul[role='listbox'] li");
            if(firstRes) firstRes.click(); 
            else search.dispatchEvent(new KeyboardEvent('keydown',{bubbles:true,cancelable:true,keyCode:13,key:'Enter'}));
            await new Promise(r=>setTimeout(r,2000));
            const msgBox = document.querySelector("div[role='textbox'][aria-label='Message']");
            if(!msgBox) return {error:"MsgBox 404"};
            msgBox.focus(); document.execCommand('insertText', false, msg);
            await new Promise(r=>setTimeout(r,800));
            const btn = document.querySelector("div[aria-label='Press enter to send']");
            if(btn) btn.click(); else msgBox.dispatchEvent(new KeyboardEvent('keydown',{bubbles:true,cancelable:true,keyCode:13,key:'Enter'}));
            return {success:true};
        }
    };
}`,
    instagram: `
if (!window.FinaInstagram) {
    console.log("Fina: Instagram Injection Loaded");
    window.FinaInstagram = {
        sendMessage: async function (contact, msg) {
            const search = document.querySelector("input[placeholder='Search']");
            if(!search) return {error:"Search 404"};
            search.focus(); document.execCommand('insertText', false, contact);
            await new Promise(r=>setTimeout(r,2000));
            const bResult = document.querySelector("div[role='button']");
            if(bResult) bResult.click();
            await new Promise(r=>setTimeout(r,2000));
            const msgBox = document.querySelector("div[role='textbox'][aria-label='Message']");
            if(!msgBox) return {error:"MsgBox 404"};
            msgBox.focus(); document.execCommand('insertText', false, msg);
            await new Promise(r=>setTimeout(r,500));
            const btn = Array.from(document.querySelectorAll("div[role='button']")).find(el => el.textContent === 'Send');
            if(btn) btn.click(); else msgBox.dispatchEvent(new KeyboardEvent('keydown',{bubbles:true,cancelable:true,keyCode:13,key:'Enter'}));
            return {success:true};
        }
    };
}`,
    discord: `
if (!window.FinaDiscord) {
    console.log("Fina: Discord Injection Loaded");
    window.FinaDiscord = {
        sendMessage: async function (contact, msg) {
            const ev = new KeyboardEvent('keydown', { ctrlKey: true, key: 'k', keyCode: 75, bubbles: true });
            document.dispatchEvent(ev);
            await new Promise(r=>setTimeout(r,1000));
            const search = document.querySelector("input[placeholder='Where would you like to go?']");
            if(search) {
                search.focus(); document.execCommand('insertText', false, contact);
                await new Promise(r=>setTimeout(r,1000));
                search.dispatchEvent(new KeyboardEvent('keydown',{bubbles:true,cancelable:true,keyCode:13,key:'Enter'}));
            }
            await new Promise(r=>setTimeout(r,2000));
            const msgBox = document.querySelector("div[role='textbox'][aria-label*='Message']");
            if(!msgBox) return {error:"MsgBox 404"};
            msgBox.focus(); document.execCommand('insertText', false, msg);
            await new Promise(r=>setTimeout(r,500));
            msgBox.dispatchEvent(new KeyboardEvent('keydown',{bubbles:true,cancelable:true,keyCode:13,key:'Enter'}));
            return {success:true};
        }
    };
}`
};

let cachedMessagingWin = null;

const logPerf = (msg) => {
    const timestamp = new Date().toISOString();
    const logMsg = `[PERF_LOG][${timestamp}] ${msg}`;
    console.log(logMsg);
    invoke("execute_shell_command", {
        command: `echo "${logMsg}" >> /home/claudio/Descargas/Fina-Ergen/Logs/perf_debug.log`
    }).catch(() => { });
};

export const openMessagingWindow = async (appId, target, message) => {
    const startTime = performance.now();
    logPerf(`Iniciando openMessagingWindow para appId: ${appId || 'Hub'}`);

    if (!isTauri) return;

    const targetUrl = appId ? (MESSAGING_URLS[appId] || '/messaging.html') : '/messaging.html';

    try {
        const messagingLabel = 'messaging';
        let cachedMessagingWin = null;

        // PRE-FETCH INMEDIATO: Intentar obtener la ventana en segundo plano al cargar el script
        if (isTauri) {
            WebviewWindow.getByLabel(messagingLabel).then(w => {
                if (w) {
                    cachedMessagingWin = w;
                    console.log("âœ… [Messaging] Ventana pre-cargada en cachÃ©");
                }
            }).catch(e => console.warn("Pre-fetch failed", e));
        }

        export const openMessagingWindow = async (appId, target, message) => {
            const startTime = performance.now();
            logPerf(`Iniciando openMessagingWindow para appId: ${appId || 'Hub'}`);

            if (!isTauri) return;

            const targetUrl = appId ? (MESSAGING_URLS[appId] || '/messaging.html') : '/messaging.html';

            try {
                const windowsChromeUA = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36";

                const startLookup = performance.now();
                if (!cachedMessagingWin) {
                    logPerf("Lookup de ventana (Race Mode)...");

                    // RACE: Si getByLabel tarda mÃ¡s de 1.5s, asumimos que algo estÃ¡ mal pero intentamos seguir
                    const getWinPromise = WebviewWindow.getByLabel(messagingLabel);
                    const timeoutPromise = new Promise(resolve => setTimeout(() => resolve('timeout'), 1500));

                    const result = await Promise.race([getWinPromise, timeoutPromise]);

                    if (result === 'timeout') {
                        logPerf("âš ï¸ Aviso: Lookup de ventana lento. Continuando con recuperaciÃ³n...");
                        // Si falla el lookup, intentamos obtenerlo de nuevo sin await bloqueante para la prÃ³xima
                        getWinPromise.then(w => cachedMessagingWin = w);
                    } else {
                        cachedMessagingWin = result;
                    }
                }
                logPerf(`Lookup finalizÃ³ en: ${(performance.now() - startLookup).toFixed(2)}ms`);

                if (cachedMessagingWin) {
                    logPerf("Reutilizando ventana existente...");

                    // ASEGURAR LISTENER
                    cachedMessagingWin.listen('wa-perf-log', (e) => {
                        logPerf(`[WHATSAPP_LOG] ${e.payload}`);
                    });

                    const startUI = performance.now();
                    cachedMessagingWin.show();
                    cachedMessagingWin.unminimize();
                    cachedMessagingWin.setFocus();
                    logPerf(`Comandos de UI enviados.`);

                    const startNav = performance.now();
                    const checkNavScript = `
                (function() {
                    if (window.location.href.indexOf("${targetUrl}") === -1 && "${targetUrl}" !== "/messaging.html") {
                        window.location.assign("${targetUrl}");
                    }
                })();
            `;

                    if (cachedMessagingWin.evaluateJavaScript) {
                        await cachedMessagingWin.evaluateJavaScript(checkNavScript);
                    }
                    logPerf(`Nav check completado.`);

                } else {
                    logPerf("Creando nueva ventana...");
                    const startCreate = performance.now();
                    cachedMessagingWin = new WebviewWindow(messagingLabel, {
                        url: targetUrl,
                        title: `Fina Messaging Center`,
                        width: 1100, height: 850,
                        visible: true, decorations: true, focus: true,
                        userAgent: windowsChromeUA
                    });

                    // ESCUCHAR LOGS DE WHATSAPP
                    cachedMessagingWin.listen('wa-perf-log', (e) => {
                        logPerf(`[WHATSAPP_LOG] ${e.payload}`);
                    });

                    cachedMessagingWin.once('tauri://error', (e) => {
                        logPerf(`ERROR EN VENTANA: ${JSON.stringify(e)}`);
                        cachedMessagingWin = null;
                    });

                    cachedMessagingWin.once('tauri://destroyed', () => {
                        logPerf("Ventana destruida.");
                        cachedMessagingWin = null;
                    });
                }

                if (target && message && INJECT_SCRIPTS[appId] && cachedMessagingWin) {
                    logPerf(`Iniciando flujo para ${target}...`);
                    const script = INJECT_SCRIPTS[appId];
                    const jsObj = `Fina${appId.charAt(0).toUpperCase() + appId.slice(1)}`;
                    const safeTarget = JSON.stringify(target);
                    const safeMessage = JSON.stringify(message);

                    const controllerScript = `
                (function() {
                    // RESET AGRESIVO LIVE
                    window._fina_booting = false;
                    window._fina_running = false;
                    if (window.FinaWhatsapp) {
                         console.log("Fina: Live Reset performing...");
                    }

                    const run = async () => {
                        if (window._fina_booting) return;
                        window._fina_booting = true;
                        
                        // Inyectar si no existe
                        if (!window.${jsObj}) {
                             ${script}
                        }

                        let attempts = 0;
                        const check = async () => {
                            attempts++;
                            if (window.location.href.indexOf("whatsapp.com") === -1 && "${appId}" === "whatsapp") {
                               if (attempts < 40) setTimeout(check, 500);
                               else window._fina_booting = false;
                               return;
                            }
                            
                            const sel = "div[contenteditable='true'], div.lexical-rich-text-input div[contenteditable='true']";
                            if (!document.querySelector(sel)) {
                                if (attempts < 40) setTimeout(check, 500);
                                else window._fina_booting = false;
                                return;
                            }

                            if (window.${jsObj} && !window._fina_running) {
                                window._fina_running = true;
                                window.${jsObj}.sendMessage(${safeTarget}, ${safeMessage})
                                    .finally(() => {
                                        window._fina_running = false;
                                        window._fina_booting = false;
                                    });
                            }
                        };
                        check();
                    };
                    run();
                })();
            `;
                    setTimeout(() => {
                        if (cachedMessagingWin) {
                            logPerf("Inyectando controlador final...");
                            if (cachedMessagingWin.evaluateJavaScript) {
                                cachedMessagingWin.evaluateJavaScript(controllerScript);
                            } else if (cachedMessagingWin.eval) {
                                cachedMessagingWin.eval(controllerScript);
                            }
                        }
                    }, 1200);
                }
            } catch (err) {
                logPerf(`ERROR FATAL EN openMessagingWindow: ${err.message}`);
                cachedMessagingWin = null;
            }
            logPerf(`Total openMessagingWindow tomÃ³: ${(performance.now() - startTime).toFixed(2)}ms`);
        };
